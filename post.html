<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading… | Kernorigin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .post-hero {
            background: var(--accent-navy);
            padding: 60px 0 52px;
        }
        .post-hero .eyebrow { color: var(--accent-gold); margin-bottom: 20px; }
        .post-hero h1 {
            color: #fff;
            font-size: 2.4rem;
            letter-spacing: -0.02em;
            margin-bottom: 20px;
            max-width: 760px;
        }
        .post-date-author { color: rgba(255,255,255,0.5); font-size: 0.88rem; }
        .post-content {
            max-width: 720px;
            margin: 0 auto;
            padding: 60px 0 80px;
        }
        .post-content h2 { font-size: 1.6rem; margin-top: 2.5rem; margin-bottom: 1rem; }
        .post-content h3 { font-size: 1.25rem; margin-top: 2rem; margin-bottom: 0.75rem; }
        .post-content p  { font-size: 1rem; line-height: 1.85; margin-bottom: 1.5rem; color: var(--text-muted); }
        .post-content ul, .post-content ol { margin-bottom: 1.5rem; line-height: 1.85; }
        .post-content li { margin-bottom: 0.5rem; color: var(--text-muted); }
        .post-summary {
            font-size: 1.05rem; color: var(--text-main); font-weight: 500;
            margin-bottom: 2.5rem; padding: 24px;
            background: var(--bg-offwhite); border-left: 4px solid var(--accent-gold);
            line-height: 1.7;
        }
        .state-loading { text-align: center; padding: 100px 0; }
        .spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--border-light);
            border-top-color: var(--accent-navy);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .state-loading p { color: var(--text-muted); font-size: 0.9rem; }
        .state-error { text-align: center; padding: 80px 0; }
        .state-error h2 { color: var(--text-muted); margin-bottom: 16px; }
        .error-debug {
            margin: 28px auto 0; text-align: left; max-width: 640px;
            background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;
            padding: 16px 20px; font-size: 0.78rem; color: #6b7280;
            white-space: pre-wrap; word-break: break-all;
        }
        .post-cta { text-align: center; padding: 60px 0; border-top: 1px solid var(--border-light); margin-top: 40px; }
        .post-cta h3 { margin-bottom: 12px; }
        .post-cta p  { max-width: 480px; margin: 0 auto 28px; }
        @media (max-width: 768px) {
            .post-hero { padding: 44px 0 36px; }
            .post-hero h1 { font-size: 1.75rem; }
            .post-content { padding: 40px 0 60px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container nav-wrapper">
            <a href="index.html" class="logo">Kernorigin</a>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="diagnostics.html" class="nav-diagnostics">Diagnostics</a></li>
                    <li><a href="how-we-think.html">How We Think</a></li>
                    <li><a href="impact.html">Impact</a></li>
                    <li><a href="partners.html">Partners</a></li>
                    <li><a href="team.html">Team</a></li>
                    <li><a href="insights.html" class="active">Insights</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- LOADING -->
        <div id="stateLoading" class="container">
            <div class="state-loading">
                <div class="spinner"></div>
                <p>Loading post…</p>
            </div>
        </div>

        <!-- ERROR -->
        <div id="stateError" style="display:none;">
            <div class="container">
                <div class="state-error">
                    <h2>Post not found</h2>
                    <p>This post may have been moved or the link is incorrect.</p>
                    <a href="insights.html" class="btn" style="margin-top:16px;">← Back to Insights</a>
                    <div id="errorDebug" class="error-debug" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- LOADED -->
        <div id="stateLoaded" style="display:none;">
            <div class="post-hero">
                <div class="container">
                    <span class="eyebrow" id="postCategory">Insight</span>
                    <h1 id="postTitle"></h1>
                    <div class="post-date-author">
                        <span id="postDate"></span><span id="postDateSep" style="display:none;"> &nbsp;·&nbsp; </span><span id="postAuthor"></span>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="post-content">
                    <div class="post-summary" id="postSummary" style="display:none;"></div>
                    <div id="postBody"></div>
                    <div class="post-cta">
                        <h3>Ready to find your root cause?</h3>
                        <p>Every transformation starts with understanding what is actually broken. Start free — takes 5 minutes.</p>
                        <a href="assessment.html" class="btn">Start Free Diagnostic</a>
                        <a href="insights.html" style="display:block; margin-top:20px; font-size:0.85rem; color:var(--text-muted);">← All insights</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container footer-wrapper">
            <div>
                <div class="footer-logo">KERNORIGIN</div>
                <p style="margin-top:15px; font-size:0.9rem;">
                    Since 2001 (formerly Value Drive Consulting)<br>
                    25 years finding root causes globally.<br>
                    50+ transformations that stick.
                </p>
            </div>
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="diagnostics.html">Diagnostics</a>
                <a href="partners.html">Partners</a>
                <a href="insights.html">Insights</a>
                <a href="contact.html">Contact</a>
            </div>
        </div>
        <div class="container" style="padding-top:20px; border-top:1px solid var(--border-light); font-size:0.8rem; color:#999;">
            &copy; 2026 Kernorigin. All rights reserved.
        </div>
    </footer>

    <script src="config.js"></script>
    <script src="mobile-menu.js"></script>
    <script>
    (function() {

        // ── 1. Read slug from URL ─────────────────────────────────────────────
        var params = new URLSearchParams(window.location.search);
        var slug   = (params.get('slug') || params.get('id') || '').trim();

        console.log('[Post] slug from URL:', JSON.stringify(slug));

        if (!slug) {
            showError('No ?slug= found in URL.', null);
            return;
        }

        // ── 2. Fetch ALL posts using the PROVEN action=recent endpoint ────────
        //
        // We do not guess an unknown single-post action name.
        // action=recent is confirmed working (used by the insights page).
        // With only 7 posts, fetching limit=100 is negligible.
        // We then find the matching slug client-side.
        //
        var apiUrl = API_CONFIG.URL + '?action=recent&limit=100';
        console.log('[Post] fetching:', apiUrl);

        fetch(apiUrl)
            .then(function(res) {
                console.log('[Post] HTTP status:', res.status);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(function(data) {

                // Normalise response — proven call returns a plain array
                var posts = [];
                if (Array.isArray(data)) {
                    posts = data;
                } else if (data && Array.isArray(data.posts)) {
                    posts = data.posts;
                } else if (data && Array.isArray(data.data)) {
                    posts = data.data;
                } else {
                    showError(
                        'Unexpected API response shape (not an array). See below.',
                        data
                    );
                    return;
                }

                console.log('[Post] posts returned:', posts.length);
                console.log('[Post] slugs in API:', posts.map(function(p){ return p.slug; }));

                // ── 3. Find by slug (exact, then case-insensitive fallback) ───
                var post = null;

                // Exact match
                for (var i = 0; i < posts.length; i++) {
                    if ((posts[i].slug || '').trim() === slug) {
                        post = posts[i];
                        break;
                    }
                }

                // Case-insensitive fallback
                if (!post) {
                    var sl = slug.toLowerCase();
                    for (var j = 0; j < posts.length; j++) {
                        if ((posts[j].slug || '').trim().toLowerCase() === sl) {
                            post = posts[j];
                            console.warn('[Post] used case-insensitive match');
                            break;
                        }
                    }
                }

                if (!post) {
                    showError(
                        'Slug not found: "' + slug + '"\n\n' +
                        'Slugs returned by API:\n' +
                        posts.map(function(p){ return '  "' + p.slug + '"'; }).join('\n'),
                        null
                    );
                    return;
                }

                console.log('[Post] matched:', post.title);
                renderPost(post);
            })
            .catch(function(err) {
                console.error('[Post] fetch error:', err);
                showError('Fetch failed: ' + err.message, null);
            });

        // ── Render ────────────────────────────────────────────────────────────
        function renderPost(post) {
            document.title = post.title + ' | Kernorigin';

            document.getElementById('postTitle').textContent    = post.title;
            document.getElementById('postCategory').textContent = post.category || post.tags || 'Insight';

            if (post.publish_date) {
                try {
                    var d = new Date(post.publish_date);
                    document.getElementById('postDate').textContent =
                        d.toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });
                    document.getElementById('postDateSep').style.display = 'inline';
                } catch(e) {
                    document.getElementById('postDate').textContent = post.publish_date;
                }
            }

            if (post.author) {
                document.getElementById('postAuthor').textContent = post.author;
            }

            if (post.summary) {
                var sumEl = document.getElementById('postSummary');
                sumEl.textContent   = post.summary;
                sumEl.style.display = 'block';
            }

            var bodyEl = document.getElementById('postBody');
            if (post.body_html) {
                bodyEl.innerHTML = post.body_html;
            } else if (post.body) {
                bodyEl.innerHTML = post.body
                    .split(/\n\n+/)
                    .map(function(p) { return '<p>' + p.replace(/\n/g, '<br>') + '</p>'; })
                    .join('');
            } else {
                bodyEl.innerHTML = '<p>No content available.</p>';
            }

            document.getElementById('stateLoading').style.display = 'none';
            document.getElementById('stateLoaded').style.display  = 'block';
        }

        // ── Error ─────────────────────────────────────────────────────────────
        function showError(msg, raw) {
            console.error('[Post] error:', msg);
            document.getElementById('stateLoading').style.display = 'none';
            document.getElementById('stateError').style.display   = 'block';
            var dbg = document.getElementById('errorDebug');
            if (dbg) {
                dbg.style.display = 'block';
                dbg.textContent   = '[Debug] ' + msg +
                    (raw ? '\n\nRaw response:\n' + JSON.stringify(raw, null, 2) : '');
            }
        }

    })();
    </script>
</body>
</html>