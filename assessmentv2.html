<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Business Assessment | Kernorigin</title>
    <meta name="description" content="10-minute AI-powered assessment reveals where your business is stuck. Get personalized recommendations based on 25 years of diagnostic experience.">
    <link rel="stylesheet" href="style.css">
    
    <!-- Razorpay Integration -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDL25WXPVP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ZDL25WXPVP');
    </script>
</head>
<body>
    <header>
        <div class="container nav-wrapper">
            <a href="index.html" class="logo" id="header-logo">Kernorigin</a>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="how-we-think.html">How We Think</a></li>
                    <li><a href="how-we-work.html">How We Work</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="impact.html">Impact</a></li>
                    <li><a href="team.html">Team</a></li>
                    <li><a href="insights.html">Insights</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="section-padding" style="background: var(--bg-offwhite);">
            <div class="container">
                <div class="readable-column">
                    <div class="text-center" style="margin-bottom: 50px;">
                        <span class="eyebrow" id="header-eyebrow">AI-Powered Diagnostic Tool</span>
                        <h1>Where Is Your Business Stuck?</h1>
                        <p style="font-size: 1.1rem; max-width: 650px; margin: 20px auto 0 auto;">
                            Answer 10 questions. Get personalized AI analysis based on our Seven Cylinders Framework‚Ñ¢. Takes 5 minutes.
                        </p>
                    </div>

                    <div id="assessment-container">
                        <!-- Introduction Screen -->
                        <div id="intro-screen" class="card" style="background: white;">
                            <h3 style="margin-top: 0;">How This AI Assessment Works</h3>
                            <p>This assessment uses AI to evaluate your organization across seven critical dimensions:</p>
                            <div class="grid-2" style="gap: 15px; margin: 25px 0;">
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">1. Strategic Clarity</p>
                                </div>
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">2. Operational Excellence</p>
                                </div>
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">3. People & Culture</p>
                                </div>
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">4. Systems & Process</p>
                                </div>
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">5. Financial Health</p>
                                </div>
                                <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px;">
                                    <p style="margin: 0; font-weight: 600;">6. Market Position</p>
                                </div>
                            </div>
                            <div style="padding: 15px; background: var(--bg-offwhite); border-radius: 4px; margin-bottom: 30px;">
                                <p style="margin: 0; font-weight: 600; text-align: center;">7. Leadership Capacity</p>
                            </div>
                            
                            <div id="partner-banner" style="background: #f0f9ff; border-left: 4px solid var(--accent-navy); padding: 20px; margin-bottom: 30px; display: none;">
                                <p style="margin: 0; font-weight: 600; color: var(--accent-navy);" id="partner-message"></p>
                            </div>
                            
                            <div style="background: #fef9e7; border-left: 4px solid var(--accent-gold); padding: 20px; margin-bottom: 30px;">
                                <p style="margin: 0;"><strong>Your AI-powered analysis will reveal:</strong></p>
                                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                    <li>Your primary bottleneck (what's actually stuck)</li>
                                    <li>Root cause vs. symptoms (why fixes haven't worked)</li>
                                    <li>Matched case studies (similar transformations)</li>
                                    <li id="intro-benefit">Specific next steps (diagnostic, workshop, or strategy)</li>
                                </ul>
                            </div>

                            <button onclick="startAssessment()" class="btn" style="width: 100%; padding: 18px;">Begin AI Assessment ‚Üí</button>
                            
                            <p style="text-align: center; margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);">
                                No signup required. Results delivered instantly + via email.
                            </p>
                        </div>

                        <!-- Questions Screen -->
                        <div id="question-screen" class="card" style="background: white; display: none;">
                            <div style="background: var(--bg-offwhite); padding: 15px; border-radius: 4px; margin-bottom: 30px;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                                    Question <span id="current-q">1</span> of 10
                                </p>
                                <div style="background: #e5e7eb; height: 6px; border-radius: 3px; margin-top: 10px;">
                                    <div id="progress-bar" style="background: var(--accent-navy); height: 100%; width: 10%; transition: width 0.3s; border-radius: 3px;"></div>
                                </div>
                            </div>

                            <h3 id="question-text" style="margin: 0 0 30px 0; font-size: 1.3rem;">Question text here</h3>
                            
                            <div id="answer-options"></div>

                            <div style="margin-top: 30px; display: flex; gap: 15px;">
                                <button onclick="previousQuestion()" id="prev-btn" class="btn-outline" style="flex: 1; display: none;">‚Üê Previous</button>
                                <button onclick="nextQuestion()" id="next-btn" class="btn" style="flex: 2;" disabled>Next Question ‚Üí</button>
                            </div>
                        </div>

                        <!-- Email Capture Screen -->
                        <div id="email-capture-screen" class="card" style="background: white; display: none;">
                            <h3 style="margin-top: 0;">Almost There! Get Your Analysis</h3>
                            <p id="email-capture-desc">Our AI is analyzing your responses. Enter your details to receive your personalized report.</p>
                            
                            <form id="email-capture-form" onsubmit="submitForAnalysis(event)">
                                <label>Your Name</label>
                                <input type="text" id="user-name" required placeholder="Full Name">
                                
                                <label>Email Address</label>
                                <input type="email" id="user-email" required placeholder="name@company.com">
                                
                                <label>Company/Organization (Optional)</label>
                                <input type="text" id="user-company" placeholder="Your Company">
                                
                                <div id="coupon-section" style="display: none; margin-top: 20px;">
                                    <label>Partner Coupon Code</label>
                                    <input type="text" id="coupon-code" placeholder="Enter your coupon code" style="text-transform: uppercase;" readonly>
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;" id="coupon-message">
                                        ‚úì Coupon applied - Full diagnostic included (‚Çπ24,997 value)
                                    </p>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 4px; margin: 20px 0;">
                                    <p style="margin: 0; font-size: 0.9rem;"><strong>What you'll get:</strong></p>
                                    <ul style="margin: 5px 0 0 0; padding-left: 20px; font-size: 0.9rem;" id="benefits-list">
                                        <li>Free 2-page summary report (instant)</li>
                                        <li>Primary bottleneck identified</li>
                                        <li>Root cause analysis overview</li>
                                        <li>Option to upgrade to full 35-page diagnostic</li>
                                    </ul>
                                </div>
                                
                                <button type="submit" class="btn" style="width: 100%;" id="submit-btn">Get My Free Analysis ‚Üí</button>
                            </form>
                            
                            <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: var(--text-muted);">
                                We respect your privacy. No spam. Unsubscribe anytime.
                            </p>
                        </div>

                        <!-- Loading Screen -->
                        <div id="loading-screen" class="card" style="background: white; display: none; text-align: center; padding: 60px 30px;">
                            <div style="margin-bottom: 30px;">
                                <div style="width: 60px; height: 60px; border: 4px solid var(--bg-offwhite); border-top: 4px solid var(--accent-navy); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            </div>
                            <h3 style="margin: 0 0 15px 0;">AI Analysis in Progress...</h3>
                            <p style="margin: 0; color: var(--text-muted);" id="loading-message">Analyzing your responses...</p>
                        </div>

                        <!-- Results Screen -->
                        <div id="results-screen" class="card" style="background: white; display: none;">
                            <div style="text-align: center; margin-bottom: 40px;">
                                <h2 style="margin: 0 0 10px 0; color: var(--accent-navy);">Your Personalized Analysis</h2>
                                <p style="margin: 0; color: var(--text-muted);" id="results-subtitle">AI-powered insights delivered</p>
                            </div>
                            
                            <div id="results-content"></div>
                            
                            <div style="background: var(--accent-navy); color: white; padding: 30px; border-radius: 8px; margin-top: 40px; text-align: center;">
                                <h3 style="color: white; margin-top: 0;">Ready to Fix What's Broken?</h3>
                                <p style="color: rgba(255,255,255,0.9); margin-bottom: 25px;">
                                    Book a 30-minute debrief call. We'll walk through your results and recommend the best path forward.
                                </p>
                                <a href="https://calendly.com/periafmalayappa" target="_blank" class="btn" style="background: var(--accent-gold); color: white;">Book Free Debrief Call ‚Üí</a>
                            </div>
                        </div>

                        <!-- Error Screen -->
                        <div id="error-screen" class="card" style="background: white; display: none;">
                            <h3 style="margin-top: 0; color: #dc2626;">Oops! Something Went Wrong</h3>
                            <p>We couldn't process your assessment right now. Don't worry‚Äîyour answers are saved.</p>
                            <p><strong>What you can do:</strong></p>
                            <ul>
                                <li>Try again in a few minutes</li>
                                <li>Or book a call directly and we'll review your assessment together</li>
                            </ul>
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button onclick="retryAnalysis()" class="btn-outline" style="flex: 1;">Try Again</button>
                                <a href="https://calendly.com/periafmalayappa" target="_blank" class="btn" style="flex: 1; text-align: center;">Book Call Instead ‚Üí</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container footer-wrapper">
            <div>
                <div class="logo" id="footer-logo">KERNORIGIN</div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                    Since 2001 (formerly Value Drive Consulting)<br>
                    25 years finding root causes globally.<br>
                    50+ transformations that stick.
                </p>
            </div>
            <div>
                <h4>Quick Links</h4>
                <ul style="list-style: none; padding: 0;">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="insights.html">Insights</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
        </div>
        <div class="container" style="margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border-light); text-align: center;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">¬© 2026 Kernorigin. All rights reserved.</p>
        </div>
    </footer>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script src="config.js"></script>
    <script>
        // ============================================
        // ULTIMATE UNIFIED ASSESSMENT SYSTEM
        // Handles: Free, Paid, Partner Coupon flows
        // ============================================
        
        // ============================================
        // 1. SMART DETECTION & INITIALIZATION
        // ============================================
        
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get('partner') || '';
        const prefillCoupon = urlParams.get('coupon') || '';
        const utmSource = urlParams.get('utm_source') || '';
        
        let partnerBranding = null;
        let assessmentState = {
            mode: 'free', // 'free', 'coupon', or 'paid'
            partnerId: partnerId,
            couponCode: prefillCoupon,
            name: '',
            email: '',
            company: '',
            fullAnswers: {},
            cylinderScores: {}
        };
        
        // Load partner branding if partner ID provided
        if (partnerId) {
            loadPartnerBranding(partnerId);
        }
        
        if (prefillCoupon) {
            assessmentState.mode = 'coupon';
            assessmentState.couponCode = prefillCoupon;
        }
        
        async function loadPartnerBranding(partnerId) {
            try {
                const response = await fetch(`${API_CONFIG.URL}?action=get_partner_branding&partnerId=${partnerId}`);
                const result = await response.json();
                
                if (result.status === 'success' && result.partner) {
                    partnerBranding = result.partner;
                    assessmentState.mode = 'coupon'; // Partner link = coupon mode
                    applyPartnerBranding(result.partner);
                }
            } catch (error) {
                console.error('Failed to load partner branding:', error);
            }
        }
        
        function applyPartnerBranding(partner) {
            // Update page branding
            document.title = `Free Business Assessment | ${partner.branding.displayName}`;
            
            // Update logos
            document.getElementById('header-logo').textContent = partner.branding.displayName;
            document.getElementById('footer-logo').textContent = `${partner.branding.displayName} √ó KERNORIGIN`;
            
            // Apply brand colors
            document.documentElement.style.setProperty('--accent-navy', partner.branding.primaryColor);
            document.documentElement.style.setProperty('--accent-gold', partner.branding.secondaryColor);
            
            // Update eyebrow
            document.getElementById('header-eyebrow').textContent = `Complimentary Diagnostic via ${partner.name}`;
            
            // Show partner banner
            const banner = document.getElementById('partner-banner');
            const message = document.getElementById('partner-message');
            banner.style.display = 'block';
            message.textContent = `‚úì You're receiving a complimentary full diagnostic courtesy of ${partner.name} (‚Çπ24,997 value)`;
            
            // Update intro benefit
            document.getElementById('intro-benefit').innerHTML = `<strong>FREE 35-page comprehensive report</strong> (normally ‚Çπ24,997)`;
        }
        
        // ============================================
        // 2. ASSESSMENT QUESTIONS
        // ============================================
        
        const questions = [
            {
                text: "How clear is your strategic direction?",
                cylinder: "strategy",
                options: [
                    { text: "Crystal clear - everyone aligned on goals", score: 4 },
                    { text: "Mostly clear - some confusion on priorities", score: 3 },
                    { text: "Unclear - different people, different visions", score: 2 },
                    { text: "No clarity - just reacting to problems", score: 1 }
                ]
            },
            {
                text: "How effective are your core operations?",
                cylinder: "operations",
                options: [
                    { text: "Smooth - repeatable processes, consistent quality", score: 4 },
                    { text: "Functional - works but needs improvement", score: 3 },
                    { text: "Chaotic - lots of firefighting", score: 2 },
                    { text: "Broken - constant crises and failures", score: 1 }
                ]
            },
            {
                text: "How would you describe your technology systems?",
                cylinder: "systems",
                options: [
                    { text: "Modern, integrated, reliable", score: 4 },
                    { text: "Adequate but aging or disconnected", score: 3 },
                    { text: "Outdated or manual workarounds common", score: 2 },
                    { text: "Broken or non-existent systems", score: 1 }
                ]
            },
            {
                text: "How would you rate your team's capability?",
                cylinder: "people",
                options: [
                    { text: "High performers - skilled and engaged", score: 4 },
                    { text: "Solid team - some skill gaps", score: 3 },
                    { text: "Struggling - high turnover or low morale", score: 2 },
                    { text: "Critical capability gaps holding us back", score: 1 }
                ]
            },
            {
                text: "How healthy is your cash flow?",
                cylinder: "financial",
                options: [
                    { text: "Strong - positive and growing", score: 4 },
                    { text: "Stable - managing but tight", score: 3 },
                    { text: "Stressed - frequent cash crunches", score: 2 },
                    { text: "Critical - survival mode", score: 1 }
                ]
            },
            {
                text: "How strong is your market position?",
                cylinder: "market",
                options: [
                    { text: "Market leader - clear differentiation", score: 4 },
                    { text: "Competitive - holding our own", score: 3 },
                    { text: "Struggling - losing ground", score: 2 },
                    { text: "Unclear positioning or commoditized", score: 1 }
                ]
            },
            {
                text: "How effective is your leadership team?",
                cylinder: "leadership",
                options: [
                    { text: "Strong - clear vision, good decisions", score: 4 },
                    { text: "Functional - gets things done", score: 3 },
                    { text: "Weak - inconsistent or unclear", score: 2 },
                    { text: "Dysfunctional - major leadership gaps", score: 1 }
                ]
            },
            {
                text: "How scalable are your current processes?",
                cylinder: "operations",
                options: [
                    { text: "Highly scalable - documented and automated", score: 4 },
                    { text: "Can scale with some effort", score: 3 },
                    { text: "Barely keeping up with current volume", score: 2 },
                    { text: "Breaking under current load", score: 1 }
                ]
            },
            {
                text: "How well do you understand your customer needs?",
                cylinder: "market",
                options: [
                    { text: "Deep understanding - backed by data", score: 4 },
                    { text: "Good understanding - some gaps", score: 3 },
                    { text: "Surface level - mostly assumptions", score: 2 },
                    { text: "Unclear - guessing or outdated info", score: 1 }
                ]
            },
            {
                text: "How predictable is your revenue?",
                cylinder: "financial",
                options: [
                    { text: "Very predictable - strong pipelines", score: 4 },
                    { text: "Somewhat predictable - some volatility", score: 3 },
                    { text: "Unpredictable - month to month uncertainty", score: 2 },
                    { text: "Highly volatile - survival mode", score: 1 }
                ]
            }
        ];

        let currentQuestion = 0;
        let answers = [];
        let userProfile = {};

        // ============================================
        // 3. ASSESSMENT FLOW
        // ============================================

        function startAssessment() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('question-screen').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
            showQuestion(0);
            
            gtag('event', 'assessment_started', { 
                'event_category': 'engagement',
                'event_label': assessmentState.mode
            });
        }

        function showQuestion(index) {
            currentQuestion = index;
            const q = questions[index];
            
            document.getElementById('current-q').textContent = index + 1;
            document.getElementById('progress-bar').style.width = ((index + 1) / questions.length * 100) + '%';
            document.getElementById('question-text').textContent = q.text;
            
            const optionsDiv = document.getElementById('answer-options');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((option, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.onclick = () => selectAnswer(i);
                
                if (answers[index] === i) {
                    btn.classList.add('selected');
                }
                
                optionsDiv.appendChild(btn);
            });
            
            document.getElementById('prev-btn').style.display = index > 0 ? 'block' : 'none';
            document.getElementById('next-btn').disabled = answers[index] === undefined;
            document.getElementById('next-btn').textContent = index === questions.length - 1 ? 'See My Results ‚Üí' : 'Next Question ‚Üí';
        }

        function selectAnswer(optionIndex) {
            answers[currentQuestion] = optionIndex;
            
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, i) => {
                btn.classList.toggle('selected', i === optionIndex);
            });
            
            document.getElementById('next-btn').disabled = false;
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            } else {
                finishAssessment();
            }
        }

        function finishAssessment() {
            // Prepare email capture screen based on mode
            if (assessmentState.mode === 'coupon') {
                // Coupon mode - show pre-filled coupon
                document.getElementById('email-capture-desc').textContent = 
                    `Your complimentary full diagnostic is ready${partnerBranding ? ' (courtesy of ' + partnerBranding.name + ')' : ''}. Enter your details to receive it.`;
                
                document.getElementById('coupon-section').style.display = 'block';
                document.getElementById('coupon-code').value = assessmentState.couponCode;
                
                document.getElementById('benefits-list').innerHTML = `
                    <li><strong>FREE 35-page comprehensive diagnostic</strong></li>
                    <li>Complete root cause analysis</li>
                    <li>Industry benchmarking</li>
                    <li>90-day action roadmap</li>
                    <li>Matched case studies</li>
                    <li>30-min debrief call included</li>
                `;
                
                document.getElementById('submit-btn').textContent = 'Get My Free Full Diagnostic ‚Üí';
            } else {
                // Free mode - normal flow
                document.getElementById('email-capture-desc').textContent = 
                    'Our AI is analyzing your responses. Enter your details to receive your free summary report.';
                
                document.getElementById('coupon-section').style.display = 'none';
                
                document.getElementById('benefits-list').innerHTML = `
                    <li>Free 2-page summary report (instant)</li>
                    <li>Primary bottleneck identified</li>
                    <li>Root cause analysis overview</li>
                    <li>Option to upgrade to full 35-page diagnostic</li>
                `;
                
                document.getElementById('submit-btn').textContent = 'Get My Free Analysis ‚Üí';
            }
            
            document.getElementById('question-screen').style.display = 'none';
            document.getElementById('email-capture-screen').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
            
            gtag('event', 'assessment_complete', { 'event_category': 'engagement' });
        }

        // ============================================
        // 4. SUBMISSION LOGIC (SMART ROUTING)
        // ============================================

        async function submitForAnalysis(event) {
            event.preventDefault();
            
            userProfile = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                company: document.getElementById('user-company').value || 'Not specified'
            };
            
            // Update state
            assessmentState.name = userProfile.name;
            assessmentState.email = userProfile.email;
            assessmentState.company = userProfile.company;
            
            // Show loading
            document.getElementById('email-capture-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
            
            // Animate loading messages
            const messages = [
                "Analyzing your responses...",
                "Matching against case patterns...",
                "Identifying bottlenecks...",
                "Generating personalized report...",
                "Almost ready..."
            ];
            
            let msgIndex = 0;
            const msgInterval = setInterval(() => {
                if (msgIndex < messages.length) {
                    document.getElementById('loading-message').textContent = messages[msgIndex];
                    msgIndex++;
                }
            }, 2000);
            
            try {
                // Prepare assessment data
                const assessmentData = prepareAssessmentData();
                
                // Use FormData to avoid CORS preflight
                const submitFormData = new FormData();
                
                // SMART ROUTING: Choose endpoint based on mode
                if (assessmentState.mode === 'coupon' && assessmentState.couponCode) {
                    // COUPON FLOW ‚Üí Partner diagnostic (full, free)
                    submitFormData.append('action', 'analyze_assessment_partner');
                    submitFormData.append('couponCode', assessmentState.couponCode);
                } else {
                    // FREE FLOW ‚Üí Basic diagnostic (2-page summary)
                    submitFormData.append('action', 'analyze_assessment');
                }
                
                submitFormData.append('apiKey', API_CONFIG.PUBLIC_KEY);
                submitFormData.append('name', assessmentData.name);
                submitFormData.append('email', assessmentData.email);
                submitFormData.append('company', assessmentData.company);
                submitFormData.append('answers', JSON.stringify(assessmentData.answers));
                submitFormData.append('scores', JSON.stringify(assessmentData.scores));
                
                // Call backend
                const response = await fetch(API_CONFIG.URL, {
                    method: 'POST',
                    body: submitFormData
                });
                
                clearInterval(msgInterval);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.error || result.message || 'Analysis failed');
                }
                
                // Display results
                displayResults(result);
                
                gtag('event', 'assessment_submitted', { 
                    'event_category': 'conversion',
                    'event_label': assessmentState.mode,
                    'value': assessmentState.mode === 'coupon' ? 25000 : 0
                });
                
            } catch (error) {
                clearInterval(msgInterval);
                console.error('Assessment error:', error);
                showError();
                
                gtag('event', 'assessment_error', { 
                    'event_category': 'error',
                    'event_label': error.toString()
                });
            }
        }

        function prepareAssessmentData() {
            const formattedAnswers = {};
            const scores = {
                strategy: 0, operations: 0, systems: 0, people: 0,
                financial: 0, market: 0, leadership: 0
            };
            
            answers.forEach((answerIndex, questionIndex) => {
                const q = questions[questionIndex];
                const option = q.options[answerIndex];
                
                if (!formattedAnswers[q.cylinder]) {
                    formattedAnswers[q.cylinder] = [];
                }
                
                formattedAnswers[q.cylinder].push({
                    question: q.text,
                    answer: option.text,
                    score: option.score || 0,
                    tag: option.tag || null
                });
                
                if (q.cylinder !== 'general' && option.score) {
                    scores[q.cylinder] += option.score;
                }
            });
            
            // Store in state
            assessmentState.fullAnswers = formattedAnswers;
            assessmentState.cylinderScores = scores;
            
            return {
                name: userProfile.name,
                email: userProfile.email,
                company: userProfile.company,
                answers: formattedAnswers,
                scores: scores,
                timestamp: new Date().toISOString()
            };
        }

        // ============================================
        // 5. RESULTS DISPLAY (MODE-AWARE)
        // ============================================

        function displayResults(result) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
            
            const resultsDiv = document.getElementById('results-content');
            
            if (assessmentState.mode === 'coupon') {
                // COUPON MODE ‚Üí Full diagnostic delivered
                displayCouponResults(result, resultsDiv);
            } else {
                // FREE MODE ‚Üí Summary + upgrade options
                displayFreeResults(result, resultsDiv);
            }
        }

        function displayCouponResults(result, container) {
            const partnerName = result.partner || 'our partner';
            
            container.innerHTML = `
                <div style="background: #10b981; color: white; padding: 25px; border-left: 4px solid #059669; margin-bottom: 30px; border-radius: 8px;">
                    <p style="margin: 0; font-size: 0.9rem; font-weight: 600;">
                        ‚úì Congratulations! Full diagnostic delivered (courtesy of ${partnerName})
                    </p>
                    <p style="margin: 10px 0 0 0; font-size: 0.85rem; opacity: 0.9;">
                        Check your email: ${userProfile.email}
                    </p>
                </div>
                
                ${result.analysis || '<p>Your comprehensive 35-page diagnostic report has been emailed to you.</p>'}
                
                <div style="background: #f0f9ff; padding: 25px; border-radius: 8px; margin-top: 40px;">
                    <h3 style="margin: 0 0 15px 0;">Next Steps:</h3>
                    <ol style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 10px;">Download and review your full diagnostic report (check email)</li>
                        <li style="margin-bottom: 10px;">Discuss findings with ${partnerName}</li>
                        <li style="margin-bottom: 10px;">For implementation support, book a consultation with Kernorigin</li>
                    </ol>
                    <a href="https://calendly.com/periafmalayappa" target="_blank" class="btn" style="margin-top: 20px; display: inline-block;">Book Implementation Consultation ‚Üí</a>
                </div>
            `;
        }

        function displayFreeResults(result, container) {
            container.innerHTML = `
                <div style="background: #f0f9ff; padding: 25px; border-left: 4px solid var(--accent-navy); margin-bottom: 30px;">
                    <p style="margin: 0; font-size: 0.9rem; font-weight: 600; color: var(--accent-navy);">
                        ‚úì Analysis complete! Summary emailed to ${userProfile.email}
                    </p>
                </div>
                
                ${result.analysis || '<p>Your 2-page summary report has been generated.</p>'}
                
                <!-- TIERED UPGRADE OPTIONS -->
                <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 40px 30px; margin-top: 50px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.8rem;">Want More Depth?</h3>
                        <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.1rem;">
                            You just got the <strong>summary</strong>. Here's what else is available:
                        </p>
                    </div>
                    
                    <!-- TIER 1: Full Diagnostic -->
                    <div style="background: white; color: #1e293b; padding: 30px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #1e3a8a;">Full 35-Page Diagnostic</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">Deep-dive root cause analysis</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 0; font-size: 0.85rem; color: #64748b; text-decoration: line-through;">‚Çπ29,997</p>
                                <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e3a8a;">‚Çπ24,997</p>
                            </div>
                        </div>
                        <ul style="margin: 0 0 20px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li>Complete 7-cylinder analysis (35 pages)</li>
                            <li>Industry benchmarking & competitive analysis</li>
                            <li>90-day action roadmap with priorities</li>
                            <li>3+ matched case studies</li>
                            <li>30-min debrief call with founder</li>
                        </ul>
                        <button onclick="showPaymentOptions('institutional')" class="btn" style="width: 100%; background: #1e3a8a; color: white;">
                            Upgrade to Full Diagnostic ‚Üí
                        </button>
                    </div>
                    
                    <!-- TIER 2: Diagnostic + DIY Toolkit -->
                    <div style="background: rgba(251, 191, 36, 0.15); border: 2px solid #fbbf24; color: #1e293b; padding: 30px; border-radius: 8px; margin-bottom: 20px; position: relative;">
                        <div style="position: absolute; top: -12px; right: 20px; background: #fbbf24; color: #1e293b; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">
                            BEST VALUE
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #1e3a8a;">Diagnostic + DIY Implementation Toolkit</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">Everything you need to fix it yourself</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 0; font-size: 0.85rem; color: #64748b; text-decoration: line-through;">‚Çπ99,997</p>
                                <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e3a8a;">‚Çπ74,997</p>
                            </div>
                        </div>
                        <ul style="margin: 0 0 20px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li><strong>Everything in Full Diagnostic +</strong></li>
                            <li>Implementation playbooks & templates</li>
                            <li>Process optimization worksheets</li>
                            <li>Financial modeling spreadsheets</li>
                            <li>90-day implementation tracker</li>
                            <li>60-min implementation kick-off call</li>
                        </ul>
                        <button onclick="alert('DIY Toolkit: Contact us at contact@kernorigin.com')" class="btn" style="width: 100%; background: #fbbf24; color: #1e293b;">
                            Get Diagnostic + Toolkit ‚Üí
                        </button>
                    </div>
                    
                    <!-- TIER 3: Guided Implementation -->
                    <div style="background: rgba(255,255,255,0.1); color: white; padding: 25px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3);">
                        <h4 style="margin: 0 0 10px 0; color: white;">Want Us to Implement for You?</h4>
                        <p style="margin: 0 0 15px 0; font-size: 0.9rem; opacity: 0.9;">
                            From ‚Çπ3-50 Lakh based on scope. Includes diagnostic + hands-on transformation.
                        </p>
                        <a href="https://calendly.com/periafmalayappa" target="_blank" class="btn-outline" style="display: inline-block; border-color: white; color: white;">
                            Book Implementation Consultation ‚Üí
                        </a>
                    </div>
                    
                    <p style="text-align: center; margin: 25px 0 0 0; font-size: 0.85rem; opacity: 0.8;">
                        üí∞ All diagnostic fees 100% credited toward implementation if you engage us within 90 days
                    </p>
                </div>
            `;
        }

        function showError() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function retryAnalysis() {
            document.getElementById('error-screen').style.display = 'none';
            document.getElementById('email-capture-screen').style.display = 'block';
        }

        // ============================================
        // 6. PAYMENT SYSTEM (for upgrades)
        // ============================================

        function showPaymentOptions(diagnosticType) {
            const options = {
                institutional: {
                    name: 'Full Institutional Diagnostic',
                    price: 2499700,
                    displayPrice: '‚Çπ24,997',
                    regularPrice: '‚Çπ29,997'
                }
            };
            
            const option = options[diagnosticType];
            
            // Simple payment flow - opens Razorpay
            const rzp = new Razorpay({
                key: 'rzp_test_k45YYLs0J4Qq0i', // ‚ö†Ô∏è REPLACE with actual key
                amount: option.price,
                currency: 'INR',
                name: 'Kernorigin',
                description: option.name,
                prefill: {
                    name: userProfile.name,
                    email: userProfile.email
                },
                theme: {
                    color: '#1e3a8a'
                },
                handler: function(response) {
                    handlePaymentSuccess(response, diagnosticType);
                }
            });
            
            rzp.open();
            
            gtag('event', 'payment_initiated', { 
                'event_category': 'conversion',
                'event_label': diagnosticType,
                'value': option.price / 100
            });
        }

        async function handlePaymentSuccess(paymentResponse, diagnosticType) {
            // Show processing
            document.getElementById('results-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'block';
            document.getElementById('loading-message').textContent = 'Processing payment and generating full diagnostic...';
            
            try {
                const assessmentData = prepareAssessmentData();
                
                const submitFormData = new FormData();
                submitFormData.append('action', 'analyze_assessment_paid');
                submitFormData.append('apiKey', API_CONFIG.PUBLIC_KEY);
                submitFormData.append('name', assessmentData.name);
                submitFormData.append('email', assessmentData.email);
                submitFormData.append('company', assessmentData.company);
                submitFormData.append('answers', JSON.stringify(assessmentData.answers));
                submitFormData.append('scores', JSON.stringify(assessmentData.scores));
                submitFormData.append('diagnosticType', diagnosticType);
                submitFormData.append('paymentId', paymentResponse.razorpay_payment_id);
                
                const response = await fetch(API_CONFIG.URL, {
                    method: 'POST',
                    body: submitFormData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showPaymentSuccessScreen(diagnosticType);
                    
                    gtag('event', 'purchase', { 
                        'transaction_id': paymentResponse.razorpay_payment_id,
                        'value': 24997,
                        'currency': 'INR'
                    });
                }
            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Payment successful! Your report will be emailed within 24 hours. Check your email for confirmation.');
            }
        }

        function showPaymentSuccessScreen(diagnosticType) {
            document.getElementById('loading-screen').style.display = 'none';
            
            const successHTML = `
                <div style="text-align: center; padding: 60px 30px;">
                    <div style="width: 80px; height: 80px; background: #10b981; border-radius: 50%; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center;">
                        <span style="color: white; font-size: 3rem;">‚úì</span>
                    </div>
                    <h2 style="margin: 0 0 15px 0;">Payment Successful!</h2>
                    <p style="font-size: 1.1rem; margin: 0 0 30px 0;">Your full diagnostic report is being generated.</p>
                    
                    <div style="background: #f0f9ff; padding: 25px; border-radius: 8px; text-align: left; max-width: 600px; margin: 0 auto 30px auto;">
                        <h3 style="margin: 0 0 15px 0;">What Happens Next:</h3>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 10px;">Payment confirmation email (within 5 minutes)</li>
                            <li style="margin-bottom: 10px;">Full 35-page diagnostic report (within 72 hours)</li>
                            <li style="margin-bottom: 10px;">Calendar link for your 30-min debrief call</li>
                            <li>100% credit toward implementation if you engage us within 90 days</li>
                        </ol>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Check your inbox: <strong>${userProfile.email}</strong></p>
                    <a href="index.html" class="btn-outline">Return to Homepage ‚Üí</a>
                </div>
            `;
            
            document.getElementById('results-screen').innerHTML = successHTML;
            document.getElementById('results-screen').style.display = 'block';
        }
    </script>
    <script src="mobile-menu.js"></script>
</body>
</html>
